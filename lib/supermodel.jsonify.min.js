(function(i,o){if("function"==typeof define&&define.amd)define(["supermodel","backbone","underscore"],o);else if("object"==typeof module&&module.exports){var e=require("supermodel"),t=require("backbone"),n=require("underscore");module.exports=o(e,t,n)}else o(i.Supermodel,i.Backbone,i._)})(this,function(i,o,e){"use strict";o.Jsonify={},o.Jsonify.VERSION="0.2.0",o.Jsonify.exToJSON=o.Model.prototype.toJSON;var t=function(i,n){return e.each(i,function(s,c){s instanceof o.Model||s instanceof o.Collection?i[c]=s.toJSON({deepJson:n}):e.isObject(s)&&n&&(i[c]=t(e.clone(s),n))}),i};o.Model.prototype.exToJSON=o.Jsonify.exToJSON,o.Model.prototype.toJSON=e.wrap(o.Jsonify.exToJSON,function(i){var o=arguments[1];o||(o={});var n;return e.isBoolean(o.omit)&&o.omit||e.isBoolean(o.pick)&&!o.pick?{}:(n=e.isBoolean(o.pick)&&o.pick||e.isBoolean(o.omit)&&!o.omit?i.call(this,o):o.pick?e.pick(this.attributes,o.pick):o.omit?e.omit(this.attributes,o.omit):i.call(this,o),n=t(n,o.deepJson))});var n=o.Model.prototype.toJSON,s=function(){var i={},o=this;do e.extend(i,o._associations),o=o.parent;while(o);return i},c=function(i){return this instanceof o.Model?r.call(this,i):this instanceof o.Collection?a.call(this,i):void 0},r=function(i){return e.isFunction(i.assoc)&&(i.pick=[],e.each(this.attributes,function(o,e){i.assoc(i.assocName,o,e,this)&&i.pick.push(e)},this)),this.toJSON(i)},a=function(i){var o=[];return this.each(function(e){o.push(r.call(e,i))},this),o},u=function(i,o){var t={};if(e.isObject(o)&&!e.isFunction(o)){var n=o["*"];if(e.isBoolean(n)&&n&&(n={pick:!0}),t=o[i],e.isBoolean(t)&&!t)return!1;if(e.isObject(o)&&!e.isFunction(o)&&e.isObject(n)&&!t&&(t=n),e.isObject(o)&&!e.isFunction(o)&&e.isBoolean(n)&&!n&&!t)return!1;if(e.isObject(o)&&!e.isFunction(o)&&e.isUndefined(n)&&!t)return!1}else e.isFunction(o)&&(t.assoc=o);return t};i.Model.prototype.toJSON=e.wrap(n,function(i){var t=arguments[1];t||(t={});var n=i.call(this,t);t.cid||delete n[this.cidAttribute];var r=t.assoc;if((e.isObject(r)||e.isBoolean(r)||e.isFunction(r))&&r){var a;if(e.isObject(r)&&!e.isFunction(r)&&(a=r["*"]),e.isObject(r)&&!e.isFunction(r)&&1===e.keys(r).length&&e.isBoolean(a)&&!a)return n;var l=s.call(this.constructor);l=e.mapObject(l,function(i){return this[i.name]()},this);for(var f in l)if(l.hasOwnProperty(f)){var d=l[f],p=u(f,r);if(!p)continue;var h=e.extend({},t,{assoc:void 0,pick:void 0,omit:void 0},p);if(t.deepAssoc){var v=e.union([],t.avoidLoop);if(!r.assoc||r.assoc&&!r.assoc[f])if(d instanceof o.Model){if(e.indexOf(v,d)>=0)continue}else if(d instanceof o.Collection&&e.indexOf(v,d.owner)>=0)continue;v=e.union(v,e.values(l),[this]),e.extend(h,{assoc:{"*":a},deepAssoc:!0,avoidLoop:v},p)}if(e.isFunction(r)){if(!r(f,void 0,void 0,d))continue;e.extend(h,{assocName:f})}n[f]=c.call(d,h)}}return n})});